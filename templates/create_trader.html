{% extends "base.html" %}
{% block head %}
    {{ super() }}
    <script src="https://unpkg.com/htmx.org/dist/ext/json-enc.js"></script>
    <script>
    const API_BASE_URL = '/api/v1';
    const TOKEN_ENDPOINT = `${API_BASE_URL}/tokens`;
    const PAIRS_API_ENDPOINT = `${API_BASE_URL}/pairs`;
    const SETTINGS_ENDPOINT = `${PAIRS_API_ENDPOINT}/settings`;

    async function loadTokens() {
        const tokens_response = await fetch(TOKEN_ENDPOINT);
        const tokens = await tokens_response.json();
        const settings_response = await fetch(SETTINGS_ENDPOINT);
        const settings = await settings_response.json();
        const fromTokenSelect = document.getElementById('from-token');
        const toTokenSelect = document.getElementById('to-token');
        const settingsSelect = document.getElementById('trading-settings');

        fromTokenSelect.innerHTML = '<option value=""></option>';
        toTokenSelect.innerHTML = '<option value=""></option>';
        settingsSelect.innerHTML = '<option value=""></option>';

        tokens.forEach(token => {
            const optionFrom = document.createElement('option');
            optionFrom.value = token.id;
            optionFrom.textContent = token.name;
            fromTokenSelect.appendChild(optionFrom);

            const optionTo = document.createElement('option');
            optionTo.value = token.id;
            optionTo.textContent = token.name;
            toTokenSelect.appendChild(optionTo);
        });
        settings.forEach(setting => {
            const optionFrom = document.createElement('option');
            optionFrom.value = setting.id;
            optionFrom.textContent = setting.name;
            settingsSelect.appendChild(optionFrom);
        });
    }

    function updateToTokenOptions() {
        const fromTokenSelect = document.getElementById('from-token');
        const toTokenSelect = document.getElementById('to-token');

        const selectedFromToken = fromTokenSelect.value;

        Array.from(toTokenSelect.options).forEach(option => {
            option.style.display = (option.value !== selectedFromToken) ? 'block' : 'none';
        });

        toTokenSelect.value = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadTokens();

        const fromTokenSelect = document.getElementById('from-token');
        fromTokenSelect.addEventListener('change', updateToTokenOptions);
    });
    </script>
{% endblock %}
{% block content %}
    <h2 class="text-2xl font-bold mb-4">Create new trader</h2>
    <form id="create-trading-pair-form"
          method="post"
          hx-post="/api/v1/pairs/"
          hx-ext='json-enc'
          hx-include="#from-token, #to-token, #pairs-settings, data-fetch-frequency"
          hx-target="#message">
        <label for="from-token" class="block text-lg font-medium text-gray-700">From Token:</label>
        <select id="from-token"
                name="from_token_id"
                class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                required></select>
        <label for="to-token" class="block text-lg font-medium text-gray-700 mt-4">To Token:</label>
        <select id="to-token"
                name="to_token_id"
                class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                required></select>
        <label for="trading-settings"
               class="block text-lg font-medium text-gray-700 mt-4">Settings:</label>
        <select id="trading-settings"
                name="trading_setting_id"
                class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                required></select>
        <label for="data-fetch-frequency"
               class="block text-lg font-medium text-gray-700 mt-4">Data Fetch Frequency (minutes):</label>
        <input type="number"
               id="data-fetch-frequency"
               name="data_fetch_frequency"
               class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
               placeholder="Enter frequency in minutes"
               required
               min="1" />
        <div class="w-full flex justify-center mt-4">
            <button type="submit"
                    class="px-4 py-2 bg-blue-500 text-white font-semibold rounded hover:bg-blue-600 transition">
                Create Trading Pair
            </button>
        </div>
    </form>
    <div id="message" class="mt-4 text-center"></div>
{% endblock %}
